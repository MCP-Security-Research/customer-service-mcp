name: Pysealer Security Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/categories/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/categories/**'

jobs:
  pysealer-check:
    runs-on: ubuntu-latest
    # Skip fork PRs where secrets are not available
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install pysealer
      run: |
        python -m pip install --upgrade pip
        pip install pysealer==0.9.0

    - name: Debug GitHub context + git access
      shell: bash
      run: |
        set -euxo pipefail
        echo "event_name=${GITHUB_EVENT_NAME}"
        echo "ref=${GITHUB_REF}"
        echo "sha=${GITHUB_SHA}"
        echo "workspace=${GITHUB_WORKSPACE}"
        echo "pwd=$(pwd)"
        git --version
        git rev-parse --is-inside-work-tree
        git rev-parse --show-toplevel
        git status --porcelain=v1
        git branch -a
        git log --oneline --decorate -n 20
        echo "==== files in src/categories ===="
        ls -la src/categories || true

    - name: Debug event payload (base/head)
      shell: bash
      run: |
        set -euxo pipefail
        echo "event payload path: $GITHUB_EVENT_PATH"
        python - <<'PY'
        import json, os
        p = os.environ["GITHUB_EVENT_PATH"]
        d = json.load(open(p))
        print("pull_request base sha:", d.get("pull_request", {}).get("base", {}).get("sha"))
        print("pull_request head sha:", d.get("pull_request", {}).get("head", {}).get("sha"))
        print("push before sha:", d.get("before"))
        print("after sha:", d.get("after"))
        PY

    - name: Debug raw git diffs for categories
      shell: bash
      run: |
        set -euxo pipefail
        if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi

        echo "BASE_SHA=$BASE_SHA"
        echo "HEAD_SHA=$HEAD_SHA"

        git cat-file -t "$BASE_SHA" || true
        git cat-file -t "$HEAD_SHA" || true

        echo "==== changed files in src/categories ===="
        git diff --name-status "$BASE_SHA" "$HEAD_SHA" -- src/categories || true

        echo "==== patch in src/categories (+/- lines) ===="
        git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" -- src/categories || true

    - name: Run pysealer check on categories
      env:
          PYSEALER_PUBLIC_KEY: ${{ secrets.PYSEALER_PUBLIC_KEY }}
      run: |
        pysealer check src/categories
